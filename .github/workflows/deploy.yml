name: Deploy to Fly.io

on:
  workflow_dispatch:  # Trigger manually
  push:
    branches:
      - prod
      - dev
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          if [[ "${GITHUB_REF_NAME}" == "prod" ]]; then
            echo "APP_NAME=ecotrackapp" >> $GITHUB_ENV
            echo "FLY_SECRET_NAME=FLY_API_TOKEN_PROD" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            echo "APP_NAME=ecotrackapp-staging" >> $GITHUB_ENV
            echo "FLY_SECRET_NAME=FLY_API_TOKEN_STAGING" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "APP_NAME=ecotrackapp-dev" >> $GITHUB_ENV
            echo "FLY_SECRET_NAME=FLY_API_TOKEN_DEV" >> $GITHUB_ENV
          fi

      - name: Deploy to Fly.io for the selected environment
        uses: superfly/flyctl-actions@1.3
        with:
          args: "deploy --remote-only --config ./backend/fly.toml --app ${{ env.APP_NAME }}"
        env:
          FLY_API_TOKEN: ${{ secrets[env.FLY_SECRET_NAME] }}

      - name: Debug environment variables
        run: |
          echo "Branch: ${GITHUB_REF_NAME}"
          echo "App Name: ${{ env.APP_NAME }}"
          echo "Token Name: ${{ env.FLY_SECRET_NAME }}"
